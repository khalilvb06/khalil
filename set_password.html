<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تعيين كلمة المرور</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Cairo', sans-serif !important; background: #f7f7f9; }
    .card { border: none; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); }
    .brand { font-weight: 800; color: #0d6efd; }
    .form-control { padding: 0.75rem 1rem; }
    .hidden { display: none !important; }
  </style>
  <script type="module">
    import { supabase } from './js/server-superbase.js';

    const statusBox = () => document.getElementById('status-box');
    const statusIcon = () => document.getElementById('status-icon');
    const statusText = () => document.getElementById('status-text');
    const formWrap = () => document.getElementById('form-wrap');
    const submitBtn = () => document.getElementById('submit-btn');

    function showStatus(kind, message) {
      // kind: success | error | info
      const box = statusBox();
      const icon = statusIcon();
      const text = statusText();
      box.classList.remove('hidden', 'alert-success', 'alert-danger', 'alert-info');
      icon.className = '';
      if (kind === 'success') {
        box.classList.add('alert', 'alert-success');
        icon.classList.add('fas', 'fa-check-circle', 'me-2');
      } else if (kind === 'error') {
        box.classList.add('alert', 'alert-danger');
        icon.classList.add('fas', 'fa-exclamation-triangle', 'me-2');
      } else {
        box.classList.add('alert', 'alert-info');
        icon.classList.add('fas', 'fa-info-circle', 'me-2');
      }
      text.textContent = message;
    }

    function parseHashParams() {
      const rawHash = window.location.hash || '';
      const hash = rawHash.startsWith('#') ? rawHash.substring(1) : rawHash;
      return new URLSearchParams(hash);
    }

    function parseQueryParams() {
      return new URLSearchParams(window.location.search || '');
    }

    async function establishSessionFromHashOrQuery() {
      // 1) Try query param error/code flow first
      const q = parseQueryParams();
      const qError = q.get('error');
      const qErrorDesc = q.get('error_description');
      const qType = q.get('type');
      if (qError) {
        return { ok: false, type: qType, error: new Error(decodeURIComponent(qErrorDesc || 'invalid link')) };
      }
      const code = q.get('code');
      if (code) {
        try {
          const { data, error } = await supabase.auth.exchangeCodeForSession(code);
          return { ok: !error, type: qType || (data && data.session ? data.session.user ? 'email_link' : '' : ''), error };
        } catch (e) {
          return { ok: false, type: qType, error: e };
        }
      }

      // 2) Fallback to hash token flow (access_token/refresh_token)
      const h = parseHashParams();
      const hType = h.get('type');
      const hError = h.get('error');
      const hErrorDesc = h.get('error_description');
      if (hError) {
        return { ok: false, type: hType, error: new Error(decodeURIComponent(hErrorDesc || 'invalid link')) };
      }
      const accessToken = h.get('access_token');
      const refreshToken = h.get('refresh_token');
      
      // Check if we have any authentication parameters at all
      if (!code && !accessToken && !refreshToken) {
        return { ok: false, type: null, error: new Error('لا يوجد رابط مصادقة صالح. يرجى استخدام الرابط المرسل في البريد الإلكتروني.') };
      }
      
      if (!accessToken) {
        return { ok: false, type: hType, error: new Error('missing access token') };
      }
      try {
        const { data, error } = await supabase.auth.setSession({ access_token: accessToken, refresh_token: refreshToken || undefined });
        return { ok: !error, type: hType, error };
      } catch (e) {
        return { ok: false, type: hType, error: e };
      }
    }

    function validatePasswords(pw, confirmPw) {
      if (!pw || pw.length < 6) return 'كلمة المرور يجب أن تكون 6 أحرف على الأقل';
      if (pw !== confirmPw) return 'كلمتا المرور غير متطابقتين';
      return null;
    }

    async function init() {
      showStatus('info', 'جاري التحقق من رابط الدعوة/الاستعادة...');

      const sessionResult = await establishSessionFromHashOrQuery();
      if (!sessionResult.ok) {
        const message = sessionResult.error && sessionResult.error.message ? sessionResult.error.message : 'رابط غير صالح أو منتهي. يرجى طلب رابط جديد.';
        showStatus('error', message.includes('expired') ? 'انتهت صلاحية الرابط. يرجى طلب رابط جديد.' : message);
        formWrap().classList.add('hidden');
        return;
      }

      // Allow both invite and recovery flows
      showStatus('success', 'تم التحقق من الرابط. يرجى تعيين كلمة المرور.');
      formWrap().classList.remove('hidden');

      const form = document.getElementById('password-form');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const validation = validatePasswords(password, confirmPassword);
        if (validation) {
          showStatus('error', validation);
          return;
        }

        submitBtn().disabled = true;
        submitBtn().innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> جاري الحفظ...';

        try {
          const { data, error } = await supabase.auth.updateUser({ password });
          if (error) {
            showStatus('error', 'تعذر تعيين كلمة المرور: ' + error.message);
            submitBtn().disabled = false;
            submitBtn().innerHTML = 'حفظ كلمة المرور';
            return;
          }

          showStatus('success', 'تم تعيين كلمة المرور بنجاح! سيتم تحويلك إلى صفحة تسجيل الدخول.');
          // Clear hash to avoid reusing token
          history.replaceState(null, '', window.location.pathname);
          setTimeout(() => { window.location.href = 'login.html'; }, 1200);
        } catch (err) {
          showStatus('error', 'حدث خطأ غير متوقع.');
          submitBtn().disabled = false;
          submitBtn().innerHTML = 'حفظ كلمة المرور';
        }
      });
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</head>
<body>
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-12 col-md-8 col-lg-5">
        <div class="text-center mb-4">
          <h2 class="brand">تعيين كلمة المرور</h2>
          <p class="text-muted mb-0">قم بإنشاء كلمة مرور لحسابك لإتمام الدعوة</p>
        </div>

        <div id="status-box" class="alert alert-info d-flex align-items-center" role="alert">
          <i id="status-icon" class="fas fa-info-circle me-2"></i>
          <div id="status-text">جارٍ التحضير...</div>
        </div>

        <div id="form-wrap" class="card p-4 hidden">
          <form id="password-form">
            <div class="mb-3">
              <label for="password" class="form-label">كلمة المرور الجديدة</label>
              <input type="password" id="password" class="form-control" placeholder="أدخل كلمة المرور" required minlength="6">
            </div>
            <div class="mb-4">
              <label for="confirm-password" class="form-label">تأكيد كلمة المرور</label>
              <input type="password" id="confirm-password" class="form-control" placeholder="أعد إدخال كلمة المرور" required minlength="6">
            </div>
            <button id="submit-btn" type="submit" class="btn btn-primary w-100">حفظ كلمة المرور</button>
          </form>
        </div>

        <div class="text-center mt-3">
          <a href="login.html" class="text-decoration-none">
            <i class="fas fa-arrow-right-to-bracket ms-1"></i>
            العودة لتسجيل الدخول
          </a>
        </div>
      </div>
    </div>
  </div>
</body>
</html>


